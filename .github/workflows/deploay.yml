name: Deploy a VPS

on:
  push:
    branches: [ "main" ] # O "master", según tu rama principal

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Bajar el código del repositorio
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Configurar Node.js para construir el Frontend
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' # O la versión que uses

    # 3. Instalar dependencias y construir el Frontend (Vite)
    - name: Build Frontend
      env:
        # Usamos "/api" para que la web busque en su propio dominio (riomarencarnacion.cloud/api)
        VITE_API_URL: "/api"
        # Usamos "/" para que el socket se conecte al mismo dominio
        VITE_SOCKET_URL: "/"
      run: |
        cd client
        npm install --legacy-peer-deps
        npm run build
    
    - name: Builda Backend
      run: |
          cd server
          npm install              # Instala todo (incluyendo typescript)
          npm run build            # Ejecuta 'tsc' y crea la carpeta 'dist'
          # Opcional: Eliminar node_modules para no copiar miles de archivos innecesarios al VPS
          rm -rf node_modules

    # 4. Copiar archivos al VPS (Frontend y Backend)
    - name: Copy files to VPS via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_IP }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        # Copiamos la carpeta dist generada y el código del servidor
        # IMPORTANTE: target debe coincidir con la ruta de tu Nginx
        source: "client/dist,server"
        target: "/home/usuario/appRioMar"
        strip_components: 0 
        # strip_components: 0 mantiene la estructura client/dist y server/

    # 5. Ejecutar comandos remotos en el VPS (Instalar deps del backend y reiniciar)
    - name: Execute remote commands via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_IP }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          # Ir a la carpeta del backend
          cd /home/usuario/appRioMar/server
          
          # Instalar dependencias nuevas del backend (si las hubiera)
          npm install --production
          
          # Reiniciar el servidor con PM2
          # Si tu proceso se llama "api-riomar", usa ese nombre
          pm2 restart appRioMar-backend || pm2 start dist/index.js --name "appRioMar-backend"
          
          echo "¡Despliegue completado con éxito!"
